<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Threat Analyzer - TICE</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç IP Threat Analyzer</h1>
            <p>Threat Intelligence Correlation Engine (TICE) - Multi-Source Analysis</p>
            <p style="font-size: 13px; color: #888; margin-top: 5px;">Sources: VirusTotal, AlienVault OTX, IPInfo</p>
        </div>

        <div class="search-box">
            <input type="text" id="ipInput" placeholder="Enter IP address (e.g., 8.8.8.8)" autocomplete="off">
            <button onclick="analyzeIP()">Analyze</button>
        </div>

        <div id="loading" class="loading hidden">
            <p>‚è≥ Analyzing IP from multiple threat intelligence sources...</p>
        </div>

        <div id="error" class="error hidden"></div>

        <div id="result" class="result hidden">
            <!-- Status -->
            <div class="section status-section">
                <h3>üéØ Threat Status</h3>
                <div id="statusBadge" class="status-badge"></div>
            </div>

            <!-- Key Info Grid -->
            <div class="grid-2">
                <!-- Threat Level -->
                <div class="section">
                    <h3>üìä Threat Analysis</h3>
                    <div class="info-box">
                        <div class="info-row">
                            <label>Threat Level:</label>
                            <span id="threatLevel" class="badge">-</span>
                        </div>
                        <div class="info-row">
                            <label>Confidence:</label>
                            <span id="confidence" class="score">0%</span>
                        </div>
                        <div class="info-row">
                            <label>Threat Score:</label>
                            <span id="aggregatedScore" style="font-size: 20px; font-weight: bold; color: #d32f2f;">0/100</span>
                        </div>
                        <div class="info-row">
                            <label>IP Address:</label>
                            <span id="ipAddress" style="font-weight: bold; color: #667eea;">-</span>
                        </div>
                    </div>
                </div>

                <!-- Reputation Stats -->
                <div class="section">
                    <h3>üìà Detection Stats</h3>
                    <div class="reputation-mini">
                        <div class="rep-stat malicious">
                            <span class="stat-value" id="repMalicious">0</span>
                            <span class="stat-label">Malicious</span>
                        </div>
                        <div class="rep-stat suspicious">
                            <span class="stat-value" id="repSuspicious">0</span>
                            <span class="stat-label">Suspicious</span>
                        </div>
                        <div class="rep-stat harmless">
                            <span class="stat-value" id="repHarmless">0</span>
                            <span class="stat-label">Harmless</span>
                        </div>
                        <div class="rep-stat undetected">
                            <span class="stat-value" id="repUndetected">0</span>
                            <span class="stat-label">Undetected</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Geolocation & Network -->
            <div class="grid-2">
                <div class="section">
                    <h3>üåç Geolocation</h3>
                    <div class="info-box">
                        <div class="info-row">
                            <label>Country:</label>
                            <span id="geoCountry">-</span>
                        </div>
                        <div class="info-row">
                            <label>Region:</label>
                            <span id="geoRegion">-</span>
                        </div>
                        <div class="info-row">
                            <label>City:</label>
                            <span id="geoCity">-</span>
                        </div>
                        <div class="info-row">
                            <label>Timezone:</label>
                            <span id="geoTimezone">-</span>
                        </div>
                        <div class="info-row">
                            <label>Coordinates:</label>
                            <span id="geoCoords">-</span>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>üè¢ Network Info</h3>
                    <div class="info-box">
                        <div class="info-row">
                            <label>ASN:</label>
                            <span id="asn" style="font-weight: bold; font-family: monospace;">-</span>
                        </div>
                        <div class="info-row">
                            <label>ISP:</label>
                            <span id="isp">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Threat Categories -->
            <div class="section">
                <h3>üè∑Ô∏è Threat Categories</h3>
                <div id="categoriesList" class="tags">
                    <span class="tag" style="background: #999;">No threats detected</span>
                </div>
            </div>

            <!-- Multi-Source Data -->
            <div class="section">
                <h3>üìö Source Detections (<span id="sourcesCount">0</span> sources)</h3>
                <div id="multiSourceList" class="sources-container"></div>
            </div>
        </div>
    </div>

    <script>
        function analyzeIP() {
            const ip = document.getElementById('ipInput').value.trim();
            if (!ip) {
                showError('Please enter an IP address');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('result').classList.add('hidden');

            fetch(`/check/${ip}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('loading').classList.add('hidden');
                    if (data.error) {
                        showError('Error: ' + (data.message || 'Unknown error'));
                    } else {
                        displayResult(data);
                    }
                })
                .catch(err => {
                    document.getElementById('loading').classList.add('hidden');
                    showError('Network Error: ' + err.message);
                });
        }

        function showError(msg) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = msg;
            errorDiv.classList.remove('hidden');
        }

        function displayResult(data) {
            console.log('API Response:', data);  // Debug log

            // IP Address
            document.getElementById('ipAddress').textContent = data.ip || '-';

            // Threat Level
            const threatLevel = data.threatLevel || 'unknown';
            document.getElementById('threatLevel').textContent = threatLevel.toUpperCase();
            document.getElementById('threatLevel').className = 'badge ' + threatLevel.toLowerCase();

            // Confidence
            document.getElementById('confidence').textContent = (data.confidenceScore || 0) + '%';

            // Aggregated Score
            document.getElementById('aggregatedScore').textContent = (data.aggregatedScore || 0) + '/100';

            // Reputation Stats
            const rep = data.reputation || {};
            document.getElementById('repMalicious').textContent = rep.malicious || 0;
            document.getElementById('repSuspicious').textContent = rep.suspicious || 0;
            document.getElementById('repHarmless').textContent = rep.harmless || 0;
            document.getElementById('repUndetected').textContent = rep.undetected || 0;

            // Geolocation
            const geo = data.geolocation || {};
            document.getElementById('geoCountry').textContent = geo.country || '-';
            document.getElementById('geoRegion').textContent = geo.region || '-';
            document.getElementById('geoCity').textContent = geo.city || '-';
            document.getElementById('geoTimezone').textContent = geo.timezone || '-';
            
            if (geo.latitude && geo.longitude && geo.latitude !== 'N/A') {
                document.getElementById('geoCoords').textContent = `${geo.latitude}, ${geo.longitude}`;
            } else {
                document.getElementById('geoCoords').textContent = '-';
            }

            // ASN & ISP
            document.getElementById('asn').textContent = geo.asn || '-';
            document.getElementById('isp').textContent = geo.isp || '-';

            // Categories
            if (data.categories && data.categories.length > 0) {
                const catHTML = data.categories.map(cat => `<span class="tag">${cat}</span>`).join('');
                document.getElementById('categoriesList').innerHTML = catHTML;
            } else {
                document.getElementById('categoriesList').innerHTML = '<span class="tag" style="background: #4caf50;">No threats detected</span>';
            }

            // Multi-Source Data
            if (data.multiSourceData && data.multiSourceData.length > 0) {
                document.getElementById('sourcesCount').textContent = data.multiSourceData.length;
                
                const srcHTML = data.multiSourceData.map((src, i) => {
                    const statusClass = src.detected ? 'detected' : 'clean';
                    const statusText = src.detected ? 'DETECTED' : 'CLEAN';
                    const statusColor = src.detected ? '#d32f2f' : '#4caf50';
                    
                    return `
                        <div class="source-item">
                            <div class="source-header">
                                <strong>${i+1}. ${src.source}</strong>
                                <span class="source-status" style="background: ${statusColor}20; color: ${statusColor};">${statusText}</span>
                            </div>
                            <div class="source-details">
                                <span class="source-type">Score: ${src.score}/100</span>
                            </div>
                            <div class="source-desc">${src.details || 'No additional details'}</div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('multiSourceList').innerHTML = srcHTML;
            }

            // Status Badge
            const badge = document.getElementById('statusBadge');
            let status = '‚úÖ SAFE';
            let badgeClass = 'safe';

            if (threatLevel === 'critical') {
                status = 'üö® CRITICAL THREAT';
                badgeClass = 'critical';
            } else if (threatLevel === 'high') {
                status = '‚ö†Ô∏è HIGH RISK';
                badgeClass = 'dangerous';
            } else if (threatLevel === 'medium') {
                status = '‚ö†Ô∏è SUSPICIOUS';
                badgeClass = 'suspicious';
            } else if (threatLevel === 'low') {
                status = '‚ö° LOW RISK';
                badgeClass = 'caution';
            }

            badge.className = 'status-badge ' + badgeClass;
            badge.textContent = status;

            document.getElementById('result').classList.remove('hidden');
        }

        // Enter key support
        document.getElementById('ipInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') analyzeIP();
        });
    </script>
</body>
</html>
